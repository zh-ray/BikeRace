<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赛事数据管理</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .login-container, .editor-container { max-width: 800px; margin: 50px auto; padding: 20px; }
        .hidden { display: none; }
        .editor-table { width: 100%; margin-top: 20px; }
        .editor-table td { padding: 8px; border: 1px solid #ddd; }
        .editor-table input { width: 100%; box-sizing: border-box; }
        .toolbar { margin: 20px 0; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>管理员登录</h2>
        <form id="loginForm">
            <input type="password" id="password" placeholder="输入管理密码" required
                   style="padding: 8px; width: 200px; margin-right: 10px;">
            <button type="submit" style="padding: 8px 16px;">登录</button>
        </form>
        <div id="loginError" class="error hidden"></div>
    </div>

    <div class="editor-container hidden">
        <div class="toolbar">
            <button onclick="addNewRow()" style="margin-right: 10px;">新增赛事</button>
            <button onclick="saveAll()">保存所有更改</button>
        </div>
        <table class="editor-table">
            <thead>
                <tr>
                    <th>赛事简称</th><th>赛事名称</th><th>地点</th><th>时间</th>
                    <th>里程</th><th>报名开始</th><th>报名结束</th><th>封路</th>
                    <th>类型</th><th>链接</th><th>操作</th>
                </tr>
            </thead>
            <tbody id="editorBody"></tbody>
        </table>
    </div>

    <script>
        let currentData = [];
        
        async function auth(password) {
            try {
                const response = await fetch('https://www.246738.xyz/api/auth/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (await auth(password)) {
                document.querySelector('.login-container').classList.add('hidden');
                document.querySelector('.editor-container').classList.remove('hidden');
                loadCSVData();
            } else {
                document.getElementById('loginError').textContent = '密码错误';
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        async function loadCSVData() {
            try {
                const response = await fetch('./race.csv');
                const csvData = await response.text();
                processCSVData(csvData);
            } catch (e) {
                console.error('加载数据失败:', e);
            }
        }

        function processCSVData(csvData) {
            const now = new Date();
            const rows = csvData.split('\n').slice(2);
            
            currentData = rows.filter(row => {
                const date = row.split(',')[3];
                return new Date(date.replace(/\./g, '-')) > now;
            }).map(row => row.split(','));

            renderEditor();
        }

        function renderEditor() {
            const tbody = document.getElementById('editorBody');
            tbody.innerHTML = '';
            
            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                row.forEach((cell, i) => {
                    if(i >= 8) return; // 跳过不需要的列
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.value = cell;
                    input.addEventListener('change', (e) => updateCell(index, i, e.target.value));
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                
                const actionTd = document.createElement('td');
                actionTd.innerHTML = `<button onclick="deleteRow(${index})">删除</button>`;
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        }

        function updateCell(rowIndex, colIndex, value) {
            currentData[rowIndex][colIndex] = value;
        }

        function addNewRow() {
            const newRow = new Array(10).fill('-');
            newRow[3] = new Date().toISOString().split('T')[0].replace(/-/g, '.');
            currentData.unshift(newRow);
            renderEditor();
        }

        function deleteRow(index) {
            currentData.splice(index, 1);
            renderEditor();
        }

        async function saveAll() {
            const csvContent = ['shortName,fullName,location,date,distance,registrationStart,registrationEnd,roadStatus,raceType,tags,webUrl',
                '赛事简称,赛事名称,赛事地点,赛事时间,赛事里程,报名开始时间,报名截止时间,封路情况（1封2半3无）,赛事类型（1普通2绕圈3爬坡）,标签,报名方式',
                ...currentData.map(row => row.join(','))].join('\n');

            try {
                await fetch('https://www.246738.xyz/api/update-csv/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/csv' },
                    body: csvContent
                });
                alert('保存成功！');
            } catch (e) {
                alert('保存失败，请重试');
            }
        }
    </script>
</body>
</html>